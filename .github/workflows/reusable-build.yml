name: Build

on:
  workflow_call:
    inputs:
      release:
        description: "Set to true when running as part of a release workflow to avoid cancelling in-progress builds."
        required: false
        type: boolean
        default: false
      node_version:
        description: "Node.js version to use for the web build"
        required: false
        type: string
        default: "22"
      go_version:
        description: "Go version to use for the server build"
        required: false
        type: string
        default: "1.25"
      yarn_version:
        description: "Yarn version to install"
        required: false
        type: string
        default: "latest"
      build_mode:
        description: "Build mode: 'static', 'cgo', or 'both'"
        required: false
        type: string
        default: "both"
      enable_static_pie:
        description: "Enable static PIE builds for supported platforms"
        required: false
        type: boolean
        default: false

  workflow_dispatch:
    inputs:
      release:
        description: "Set to true to emulate a release build."
        required: false
        type: boolean
        default: false
      node_version:
        description: "Node.js version to use for the web build"
        required: false
        type: string
        default: "22"
      go_version:
        description: "Go version to use for the server build"
        required: false
        type: string
        default: "1.25"
      yarn_version:
        description: "Yarn version to install"
        required: false
        type: string
        default: "latest"
      build_mode:
        description: "Build mode: 'static', 'cgo', or 'both'"
        required: false
        type: string
        default: "both"
      enable_static_pie:
        description: "Enable static PIE builds for supported platforms"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: ${{ (inputs.release && format('release-{0}', github.run_id)) || format('build-{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: ${{ !inputs.release }}

jobs:
  build:
    name: Build (${{ matrix.artifact }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux platforms with comprehensive CGO support
          - target: linux/amd64
            artifact: linux-amd64
            cgo_support: full
            musl_support: true
          - target: linux/arm64
            artifact: linux-arm64
            cgo_support: full
          - target: linux/arm/7
            artifact: linux-arm7
            cgo_support: full
          - target: linux/arm/5
            artifact: linux-arm5
            cgo_support: full
          - target: linux/386
            artifact: linux-386
            cgo_support: full
          - target: linux/mips
            artifact: linux-mips
            cgo_support: limited
          - target: linux/mipsle
            artifact: linux-mipsle
            cgo_support: limited
          - target: linux/mips64
            artifact: linux-mips64
            cgo_support: limited
          - target: linux/mips64le
            artifact: linux-mips64le
            cgo_support: limited
          - target: linux/riscv64
            artifact: linux-riscv64
            cgo_support: limited

          # Windows platforms
          - target: windows/amd64
            artifact: windows-amd64
            cgo_support: full
          - target: windows/386
            artifact: windows-386
            cgo_support: full

          # Darwin platforms (CGO cross-compilation complex)
          - target: darwin/amd64
            artifact: darwin-amd64
            cgo_support: none
          - target: darwin/arm64
            artifact: darwin-arm64
            cgo_support: none

          # FreeBSD platforms
          - target: freebsd/amd64
            artifact: freebsd-amd64
            cgo_support: none
          - target: freebsd/arm/7
            artifact: freebsd-arm7
            cgo_support: none

          # Android platforms (always use CGO)
          - target: android/arm/7
            artifact: android-arm7
            android: true
            cgo_support: android
          - target: android/arm64
            artifact: android-arm64
            android: true
            cgo_support: android
          - target: android/386
            artifact: android-386
            android: true
            cgo_support: android
          - target: android/amd64
            artifact: android-amd64
            android: true
            cgo_support: android

    env:
      BUILD_TARGET: ${{ matrix.target }}
      BUILD_MODE: ${{ inputs.build_mode || 'both' }}
      ENABLE_STATIC_PIE: ${{ inputs.enable_static_pie || 'false' }}
      NODE_VERSION: ${{ inputs.node_version || '22' }}
      GO_VERSION: ${{ inputs.go_version || '1.25' }}
      YARN_VERSION: ${{ inputs.yarn_version || 'latest' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Yarn
        run: npm install -g yarn@${{ env.YARN_VERSION }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Download Android NDK
        if: ${{ matrix.android }}
        run: |
          wget -q "https://dl.google.com/android/repository/android-ndk-r25c-linux.zip"
          unzip -q ./android-ndk-r25c-linux.zip
          rm ./android-ndk-r25c-linux.zip

      - name: Install musl development tools
        if: ${{ matrix.musl_support }}
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev

      - name: Setup cross-compilers for CGO
        if: ${{ matrix.cgo_support != 'none' && matrix.cgo_support != 'android' }}
        run: |
          sudo apt-get update
          case "${{ matrix.target }}" in
            linux/amd64)
              sudo apt-get install -y build-essential gcc libc6-dev
              ;;
            linux/386)
              sudo apt-get install -y gcc-multilib libc6-dev-i386
              ;;
            linux/arm64)
              sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
              ;;
            linux/arm/*)
              sudo apt-get install -y gcc-arm-linux-gnueabihf libc6-dev-armhf-cross
              ;;
            linux/mips)
              sudo apt-get install -y gcc-mips-linux-gnu libc6-dev-mips-cross || echo "MIPS toolchain may not be available"
              ;;
            linux/mipsle)
              sudo apt-get install -y gcc-mipsel-linux-gnu libc6-dev-mipsel-cross || echo "MIPSEL toolchain may not be available"
              ;;
            linux/mips64)
              sudo apt-get install -y gcc-mips64-linux-gnuabi64 libc6-dev-mips64-cross || echo "MIPS64 toolchain may not be available"
              ;;
            linux/mips64le)
              sudo apt-get install -y gcc-mips64el-linux-gnuabi64 libc6-dev-mips64el-cross || echo "MIPS64EL toolchain may not be available"
              ;;
            linux/riscv64)
              sudo apt-get install -y gcc-riscv64-linux-gnu libc6-dev-riscv64-cross || echo "RISC-V toolchain may not be available"
              ;;
            windows/amd64)
              sudo apt-get install -y mingw-w64 gcc-mingw-w64-x86-64
              ;;
            windows/386)
              sudo apt-get install -y mingw-w64 gcc-mingw-w64-i686
              ;;
            *)
              echo "No specific cross-compiler setup for ${{ matrix.target }}"
              ;;
          esac

      - name: Verify toolchain installation
        if: ${{ matrix.cgo_support == 'full' }}
        run: |
          echo "=== Toolchain Verification ==="
          case "${{ matrix.target }}" in
            linux/amd64)
              gcc --version || echo "GCC not available"
              echo | gcc -E -dM - | grep -E "__GLIBC__|__MUSL__" || echo "No libc info"
              ;;
            linux/arm64)
              aarch64-linux-gnu-gcc --version || echo "ARM64 GCC not available"
              ;;
            linux/arm/*)
              arm-linux-gnueabihf-gcc --version || echo "ARM GCC not available"
              ;;
            windows/amd64)
              x86_64-w64-mingw32-gcc --version || echo "MinGW64 GCC not available"
              ;;
            windows/386)
              i686-w64-mingw32-gcc --version || echo "MinGW32 GCC not available"
              ;;
          esac

          # Check for musl-gcc if musl support enabled
          if [[ "${{ matrix.musl_support }}" == "true" ]]; then
            musl-gcc --version || echo "musl-gcc not available"
          fi

      - name: Run build script
        run: |
          ./build-github.sh

      - name: Validate binary linking (Linux AMD64 only)
        if: ${{ matrix.target == 'linux/amd64' }}
        run: |
          echo "=== Binary Analysis ==="
          cd dist/

          for binary in TorrServer-linux-amd64*; do
            if [[ -f "$binary" ]]; then
              echo
              echo "Analyzing: $binary"

              # File information
              file "$binary"

              # Size information
              ls -lh "$binary"

              # Check linking
              LDD_OUTPUT=$(ldd "$binary" 2>&1 || true)
              echo "Linking info: $LDD_OUTPUT"

              # For CGO binaries, verify they have expected dynamic links
              if [[ "$binary" =~ -cgo ]] || [[ "$binary" =~ -dynamic ]]; then
                if echo "$LDD_OUTPUT" | grep -q "not a dynamic executable"; then
                  echo "WARNING: CGO binary appears to be static (unexpected)"
                else
                  echo "✓ CGO binary is dynamically linked (expected)"
                fi
              fi

              # For static binaries, verify they are actually static
              if [[ "$binary" =~ -static ]]; then
                if echo "$LDD_OUTPUT" | grep -q "not a dynamic executable"; then
                  echo "✓ Static binary is properly static"
                else
                  echo "WARNING: Static binary appears to be dynamic"
                fi
              fi
            fi
          done

      - name: Test binary execution (Linux AMD64 only)
        if: ${{ matrix.target == 'linux/amd64' }}
        run: |
          echo "=== Binary Execution Test ==="
          cd dist/

          for binary in TorrServer-linux-amd64*; do
            if [[ -f "$binary" && -x "$binary" ]]; then
              echo "Testing: $binary"
              timeout 5 ./"$binary" --help || echo "Binary execution test completed"
            fi
          done

      - name: Upload build artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: TorrServer-${{ matrix.artifact }}-${{ env.BUILD_MODE }}
          path: |
            dist/TorrServer-${{ matrix.artifact }}*
            !dist/*.log
          retention-days: 30

      # - name: Upload build logs (on failure)
      #   if: failure()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: build-logs-${{ matrix.artifact }}
      #     path: |
      #       *.log
      #       /tmp/*.log
      #     retention-days: 7

  # Summary job to collect results
  # build-summary:
  #   name: Build Summary
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: always()
  #   steps:
  #     - name: Check build results
  #       run: |
  #         echo "=== Build Summary ==="
  #         echo "Build mode: ${{ inputs.build_mode || 'both' }}"
  #         echo "Static PIE enabled: ${{ inputs.enable_static_pie || 'false' }}"
  #         echo

  #         # This job will show the overall status
  #         if [[ "${{ needs.build.result }}" == "success" ]]; then
  #           echo "✅ All builds completed successfully"
  #         elif [[ "${{ needs.build.result }}" == "failure" ]]; then
  #           echo "❌ Some builds failed"
  #           exit 1
  #         else
  #           echo "⚠️  Build completed with issues"
  #         fi

  #     - name: Download all artifacts (for release builds)
  #       if: ${{ inputs.release }}
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: release-artifacts/

  #     - name: List release artifacts
  #       if: ${{ inputs.release }}
  #       run: |
  #         echo "=== Release Artifacts ==="
  #         find release-artifacts/ -type f -name "TorrServer-*" | sort
